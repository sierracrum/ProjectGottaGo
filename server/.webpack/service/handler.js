!function(e,t){for(var i in t)e[i]=t[i]}(exports,function(e){var t={};function i(o){if(t[o])return t[o].exports;var s=t[o]={i:o,l:!1,exports:{}};return e[o].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,o){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(i.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)i.d(o,s,function(t){return e[t]}.bind(null,s));return o},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=1)}([function(e,t){e.exports=require("axios")},function(e,t,i){const o=i(2),s=i(3),a=i(4),d=(i(0),i(5));o.config.update({region:process.env.R_AWS_REGION,accessKeyId:process.env.R_AWS_KEY,secretAccessKey:process.env.R_AWS_SECRET});const n=new o.DynamoDB;e.exports.auth=((e,t,i)=>{i(null,((e,t,i)=>{let o={};if(o.principalId=e,t&&i){const e={Version:"2012-10-17",Statement:[]},s={Action:"execute-api:Invoke"};s.Effect=t,s.Resource=i,e.Statement[0]=s,o.policyDocument=e}return o})("demo-user","Allow",e.methodArn))}),e.exports.getAllStatuses=((e,t,i)=>{const o={TableName:"risk-gtg-status",AttributesToGet:["id","buildingId","floorId","doorId","status","dt"]};n.scan(o,(e,t)=>{if(e)console.log(e),i("Failed getting status",e);else{let e=[];t.Items.map(t=>{e.push({id:t.id.S,doorId:parseInt(t.doorId.N),floorId:parseInt(t.floorId.N),buildingId:parseInt(t.buildingId.N),status:parseInt(t.status.N),dt:t.dt.S})}),i(null,a.sortBy(e,"dt").reverse())}})}),e.exports.getStatusById=((e,t,i)=>{const o={TableName:dbTableName,Key:{id:e.path.id}};n.get(o,(e,t)=>{e?(console.error(e),i("Failed fetching status",null)):i(null,JSON.stringify(t.Item))})}),e.exports.createStatus=((e,t,i)=>{const a=e.body;a||i("Status data required",null),a.buildingId||i("Building ID required",null),a.floorId||i("Floor ID required",null),a.doorId||i("Door ID required",null);const n={TableName:"risk-gtg-status",Item:{id:{S:s.v1()},buildingId:{N:a.buildingId.toString()},floorId:{N:a.floorId.toString()},doorId:{N:a.doorId.toString()},status:{N:a.status.toString()},dt:{S:(new Date).getTime().toString()}}},p=new o.DynamoDB;p.putItem(n,function(e,t){if(e)console.log(e),i("Failed storing status",e);else{const e={TableName:"risk-gtg-user",AttributesToGet:["id","userId","userName","action","dt"]};p.scan(e,(e,t)=>{if(e)console.log(e),i("Failed fetching users",e);else{const e=d.getUserMessages(t.Items,a.floorId);e.length?d.sendNotifications(e,a.floorId,(t,o)=>{t?(console.log(t),i("Failed sending messages",t)):d.deleteUsers(e,p,"risk-gtg-user",(e,t)=>{e?(console.log(e),i("Failed deleting users",e)):i(null,!0)})}):i(null,!0)}})}})}),e.exports.slackStatus=((e,t,i)=>{console.log("body",e.body);const o={TableName:"risk-gtg-status",AttributesToGet:["id","buildingId","floorId","doorId","status","dt"]};n.scan(o,(e,t)=>{if(e)console.log(e),i("Failed getting status",e);else{let e=[],s=[];t.Items.map(e=>{s.push({id:e.id.S,doorId:parseInt(e.doorId.N),floorId:parseInt(e.floorId.N),buildingId:parseInt(e.buildingId.N),status:parseInt(e.status.N),dt:e.dt.S})}),a.sortBy(s,"dt").reverse().map(t=>{-1===a.findIndex(e,{doorId:t.doorId,floorId:t.floorId})&&e.push(t)});let d={},n="",l=[],m=0;for(let t=0;t<e.length;t++)1===e[t].status?(m+=1,d[e[t].floorId]?d[e[t].floorId]++:d[e[t].floorId]=1):l.push(e[t].floorId);for(var o in d){n+="Floor "+o+": "+d[o]+" available\n"}n+="\n";let h="",u="";switch(m){case 0:u="Gotta wait, no bathrooms are available!",h=a.sample(r);break;case 1:u="Gotta hurry, one bathrooms is available!",h=a.sample(g);break;default:u="Gotta choose, there are multiple bathrooms available!",h=a.sample(p)}i(null,{attachments:[{pretext:u,text:n,callback_id:"notify",color:"good",attachment_type:"default",actions:[{name:"notify",text:"Notify options...",type:"select",options:[{text:"Any",value:"any"},{text:"1st Floor",value:"1"},{text:"2nd Floor",value:"2"},{text:"3rd Floor",value:"3"}]}]},{text:"GottaGo",image_url:h}]})}})}),e.exports.slackStatusNotify=((e,t,i)=>{const a=JSON.parse(e.body.payload);console.log(a),console.log(a.actions[0].selected_options[0]);const d={TableName:"risk-gtg-user",Item:{id:{S:s.v1()},userId:{S:a.user.id},userName:{S:a.user.name},action:{S:a.actions[0].selected_options[0].value},dt:{S:(new Date).getTime().toString()}}};(new o.DynamoDB).putItem(d,function(e,t){e?(console.log(e),i("Failed storing status",e)):i(null,"I will notify you when a bathroom opens up")})});const p=["https://media.giphy.com/media/5GoVLqeAOo6PK/giphy.gif","https://media.giphy.com/media/RrVzUOXldFe8M/giphy.gif","https://media.giphy.com/media/JltOMwYmi0VrO/giphy.gif","https://media.giphy.com/media/WUq1cg9K7uzHa/giphy.gif","https://media.giphy.com/media/31lPv5L3aIvTi/giphy.gif","https://media.giphy.com/media/y8Mz1yj13s3kI/giphy.gif","https://media.giphy.com/media/3oKIP9iTS7Ze73m1P2/giphy.gif","https://media.giphy.com/media/aMh59aKR8vjdC/giphy.gif","https://media.giphy.com/media/3o7abldj0b3rxrZUxW/giphy.gif","https://media.giphy.com/media/cbG9wtoO8QScw/giphy.gif","https://media.giphy.com/media/yIsbuPCEOgNHO/giphy.gif","https://media.giphy.com/media/13mbTHVskEHyGA/giphy.gif","https://media.giphy.com/media/AuwBPJztsEWkw/giphy.gif","https://media.giphy.com/media/sIfvjuG26APYI/giphy.gif"],g=["https://media.giphy.com/media/l2Sqc3POpzkj5r8SQ/giphy.gif","https://media.giphy.com/media/1iTH1WIUjM0VATSw/giphy.gif","https://media.giphy.com/media/l0HUjziiiniIsRUY0/giphy.gif","https://media.giphy.com/media/7kn27lnYSAE9O/giphy.gif","https://media.giphy.com/media/3oKIPoZniJ2hq8IItG/giphy.gif","https://media.giphy.com/media/wAClK9HIiBdBu/giphy.gif","https://media.giphy.com/media/kuFDac2MnJN2U/giphy.gif","https://media.giphy.com/media/Emg9qPKR5hquI/giphy.gif","https://media.giphy.com/media/6QXdPW7qzTVxC/giphy.gif","https://media.giphy.com/media/l2SpMwIcaPAVg8dnq/giphy.gif","https://media.giphy.com/media/7XsFGzfP6WmC4/giphy.gif","https://media.giphy.com/media/l4pT47HmuSgXIyXbq/giphy.gif"],r=["https://media.giphy.com/media/3t7RAFhu75Wwg/giphy.gif","https://media.giphy.com/media/LX5lCAnX1yais/giphy.gif","https://media.giphy.com/media/ug9SeZBFLKHtK/giphy.gif","https://media.giphy.com/media/l3978hPCi5iREQk5W/giphy.gif","https://media.giphy.com/media/Rhkq4ehWqVX56/giphy.gif","https://media.giphy.com/media/CMRWlA55AYLpS/giphy.gif","https://media.giphy.com/media/jSfiX3lj42RDG/giphy.gif","https://media.giphy.com/media/l2JhtKtDWYNKdRpoA/giphy.gif","https://media.giphy.com/media/8pMS5BXOUVZyo/giphy.gif","https://media.giphy.com/media/xUOxfeS1G9NTxN02Ag/giphy.gif","https://media.giphy.com/media/KDRv3QggAjyo/giphy.gif","https://media.giphy.com/media/Ty9Sg8oHghPWg/giphy.gif","https://media.giphy.com/media/l3V0H7bYv5Ml5TOfu/giphy.gif","https://media.giphy.com/media/54PaD9dWT0go/giphy.gif","https://media.giphy.com/media/4qmcuu67Hxx0Q/giphy.gif","https://media.giphy.com/media/tJeGZumxDB01q/giphy.gif","https://media.giphy.com/media/tJeGZumxDB01q/giphy.gif"]},function(e,t){e.exports=require("aws-sdk")},function(e,t){e.exports=require("uuid")},function(e,t){e.exports=require("lodash")},function(e,t,i){const o=i(6),s=i(0);e.exports={getUserMessages:(e,t)=>{let i=[];return console.log(t),e.map(e=>{const o=e.userId.S,s=e.id.S,a=e.action.S;"any"!==a&&t!==a||i.push({id:s,userId:o,msg:`A bathroom on floor ${t} is open!`})}),i},sendNotifications:(e,t,i)=>{o.map(e,(e,t)=>{s.post(`https://slack.com/api/im.open?token=${process.env.SLACK_TOKEN}&user=${e.userId}`,{headers:{"Content-Type":"application/json"}}).then(i=>{s.post(`https://slack.com/api/chat.postMessage?token=${process.env.SLACK_TOKEN}&channel=${i.data.channel.id}&text=${e.msg}`).then(i=>{t(null,e)})})},(e,t)=>{e?i(e,null):i(null,t)})},deleteUsers:(e,t,i,s)=>{o.map(e,(e,o)=>{var s={TableName:i,Key:{id:{S:e.id}}};t.deleteItem(s,(e,t)=>{e?o(e,null):o(null,t)})},(e,t)=>{e?s(e,null):s(null,t)})}}},function(e,t){e.exports=require("async")}]));
//# sourceMappingURL=handler.js.map